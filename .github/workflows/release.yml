name: Build and Release FloatVision

on:
  push:
    tags:
      - 'v*' # v1.0.0 などのタグがプッシュされたら実行

jobs:
  build:
    runs-on: windows-latest # VS2026環境を含む最新ランナー
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. MSBuildのセットアップ (VS2026/v145対応のため最新を指定)
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: 'latest'

      # 2. NuGetのセットアップと復元 (WebView2等のパッケージ取得)
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore FloatVision.slnx

      # 3. ビルド実行
      # PlatformToolsetをv143(VS2022互換)にし、
      # WindowsTargetPlatformVersionを最新(10.0)に、
      # さらに TargetGenerateFullPaths を追加してパス解決を確実にします。
      - name: Build app
        run: |
          msbuild FloatVision.slnx /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsTargetPlatformVersion=10.0

      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path ./publish_dist -Force

          # 1. EXE本体のみをコピー
          Get-ChildItem -Path . -Filter "FloatVision.exe" -Recurse | Where-Object { $_.FullName -notmatch "obj" -and $_.FullName -notmatch "publish_dist" } | Select-Object -First 1 | ForEach-Object {
              Copy-Item $_.FullName -Destination ./publish_dist/
          }

          # 2. もし Microsoft.Web.WebView2.*.dll も不要（静的リンク）ならここも空にできますが
          # 念のためこれらが本当に不要か、一度手動で消して確認してみてください。
          
          Write-Host "--- Final Package Contents ---"
          ls ./publish_dist

          # 抽出結果をログで確認
          Write-Host "--- Files to be zipped ---"
          ls ./publish_dist

      # 5. ZIP圧縮
      - name: Archive Release
        shell: pwsh
        run: |
          Compress-Archive -Path ./publish_dist/* -DestinationPath FloatVision-v${{ github.ref_name }}.zip

      # 6. GitHub Release 作成とアップロード
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: FloatVision-v${{ github.ref_name }}.zip
          generate_release_notes: true # コミットログからリリースノートを自動生成
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
