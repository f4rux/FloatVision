name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-2025 # VS2026環境
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. MSBuildのセットアップ (C++にはこれが必須です)
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # 1.5. NuGetのセットアップとパッケージ復元
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore FloatVision.slnx

      # 2. ビルド実行 (dotnetではなくmsbuildを直接使う)
      # .slnx は最新の MSBuild なら解釈可能です
      - name: Build app
        run: |
          msbuild FloatVision.slnx /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=Default

      # 3. 成果物をZIPにまとめる
      # MSBuildの場合、通常はプロジェクトフォルダ内の x64/Release に出力されます
      - name: Archive build artifacts
        shell: pwsh
        run: |
          # 出力先パスが異なる場合はここを調整してください
          Compress-Archive -Path FloatVision/x64/Release/* -DestinationPath FloatVision-v${{ github.ref_name }}.zip

      # 4. リリース作成
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: FloatVision-v${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
